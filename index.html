<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>17th</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js"></script>

    <!-- Leaflet Rotate -->
    <script src="https://unpkg.com/leaflet-rotate/dist/leaflet-rotate.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        #map { width: 100vw; height: 100vh; }

        #compass-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border-radius: 50%;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 9999;
            font-size: 20px;
        }

        #follow-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #0078FF;
            color: white;
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 9999;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="compass-btn">ðŸ§­</div>
<div id="follow-btn">FOLLOW: ON</div>

<script>
/* ---------------- MAP SETUP ---------------- */
const map = L.map("map", {
    center: [20.5937, 78.9629],
    zoom: 18,
    rotate: true,
    touchRotate: true,
    compassBearing: false, // prevents auto rotation overrides
});

/* ---------------- TILE LAYER ---------------- */
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 22
}).addTo(map);

/* ---------------- VARIABLES ---------------- */
let followMode = true;
let userRotating = false;
let lastHeading = 0;

/* ---------------- USER MARKER ---------------- */
const userIcon = L.marker([0, 0], {
    icon: L.divIcon({
        html: "â¬¤",
        className: "",
        iconSize: [15, 15],
        iconAnchor: [7, 7]
    })
}).addTo(map);

/* ---------------- HELPERS ---------------- */
function normalizeHeading(h) {
    return Math.abs(h) < 1 ? 0 : h;
}

/* ---------------- GEO TRACKING ---------------- */
navigator.geolocation.watchPosition(
    (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const heading = pos.coords.heading !== null ? pos.coords.heading : lastHeading;
        lastHeading = heading;

        userIcon.setLatLng([lat, lng]);

        // Only rotate if map is in follow mode AND user is not rotating manually
        if (followMode && !userRotating) {
            map.setBearing(normalizeHeading(heading), { animate: true, duration: 250 });
        }

        // Follow position only when in follow mode
        if (followMode) {
            map.setView([lat, lng], map.getZoom(), { animate: true });
        }
    },
    (err) => console.log("GPS ERROR:", err),
    { enableHighAccuracy: true }
);

/* ---------------- USER INTERACTION ---------------- */
map.on("mousedown touchstart", () => {
    followMode = false;
    document.getElementById("follow-btn").innerText = "FOLLOW: OFF";
});

// when user manually rotates map
map.on("rotatestart", () => {
    userRotating = true;
});

// allow small pause before GPS is allowed to rotate again
map.on("rotateend", () => {
    setTimeout(() => userRotating = false, 700);
});

/* ---------------- BUTTONS ---------------- */
document.getElementById("follow-btn").onclick = () => {
    followMode = !followMode;
    document.getElementById("follow-btn").innerText =
        `FOLLOW: ${followMode ? "ON" : "OFF"}`;
};

document.getElementById("compass-btn").onclick = () => {
    map.setBearing(0, { animate: true, duration: 300 });
};
</script>
</body>
</html>
