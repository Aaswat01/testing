<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Stable Rotation Fix</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js"></script>

    <!-- Leaflet-Rotate -->
    <script src="leaflet-rotate-src.js"></script>

    <style>
        body { margin:0; overflow:hidden; }
        #map { width:100vw; height:100vh; }

        #follow-btn {
            position:absolute;
            bottom:15px;
            right:15px;
            background:#0078FF;
            color:white;
            padding:10px 14px;
            border-radius:12px;
            z-index:9999;
            cursor:pointer;
            font-weight:bold;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="follow-btn">FOLLOW: ON</div>

<script>
/* ---------------- MAP ---------------- */
const map = L.map("map", {
    center:[20.5937,78.9629],
    zoom:18,
    rotate:true,
    touchRotate:true,
    compassBearing:false, // IMPORTANT FIX
    rotateControl:true
});

/* ---------------- LAYER ---------------- */
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom:22
}).addTo(map);

/* ---------------- STATE ---------------- */
let follow = true;
let lastHeading = 0;

/* ---------------- MARKER ---------------- */
const userMarker = L.marker([0,0]).addTo(map);

/* ---------------- FOLLOW BUTTON ---------------- */
document.getElementById("follow-btn").onclick = () => {
    follow = !follow;
    document.getElementById("follow-btn").textContent = `FOLLOW: ${follow ? "ON" : "OFF"}`;
};

/* ---------------- GPS ---------------- */
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const heading = pos.coords.heading ?? lastHeading;
            lastHeading = heading;

            userMarker.setLatLng([lat,lng]);

            if (follow) {
                map.setView([lat,lng], map.getZoom(), { animate:true });

                // Apply heading only when device is moving (>1Â°)
                if (heading !== null && pos.coords.speed > 1) {
                    map.setBearing(heading, { animate:true, duration:300 });
                }
            }
        },
        console.log,
        { enableHighAccuracy:true }
    );
}
</script>

</body>
</html>
