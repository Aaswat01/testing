<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Leaflet Rotate Demo</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet Rotate Plugin -->
    <script src="https://unpkg.com/leaflet-rotate/dist/leaflet-rotate.js"></script>

    <style>
        body { margin:0; overflow:hidden; }
        #map { width:100vw; height:100vh; }

        #compass {
            position:absolute;
            top:15px;
            right:15px;
            background:white;
            padding:10px;
            border-radius:50%;
            cursor:pointer;
            box-shadow:0 3px 10px rgba(0,0,0,0.3);
            z-index:9999;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="compass">ðŸ§­</div>

<script>
/* ---------------- MAP INITIALIZATION ---------------- */
const map = L.map("map", {
    center: [0,0],
    zoom: 18,
    rotate: true     // enables rotation plugin
});

// Base map
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom:19
}).addTo(map);

// User marker (car)
const userIcon = L.circleMarker([0,0], { radius:8, color:"red" }).addTo(map);

let autoCenter = true;
let userInteracting = false;
let hasGPSFix = false;

/* ---------------- STOP AUTO-CENTER WHEN USER TOUCHES MAP ---------------- */
map.on("mousedown touchstart", () => {
    autoCenter = false;
    userInteracting = true;
});

map.on("mouseup touchend", () => {
    setTimeout(()=> userInteracting=false, 1500);
});

/* ---------------- COMPASS RESET ---------------- */
document.getElementById("compass").onclick = () => {
    map.setBearing(0);
    autoCenter = true;
    userInteracting = false;
};

/* ---------------- LOCATION + ROTATION ---------------- */
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const heading = pos.coords.heading || 0; // if no heading, default 0

        userMarkerPosition = [lat, lng];
        userIcon.setLatLng(userMarkerPosition);

        // Rotate map smoothly
        map.setBearing(heading);

        // Center only if user didn't touch map
        if (autoCenter && !userInteracting) {
            map.setView(userMarkerPosition, map.getZoom(), { animate: true });
        }

    }, err => console.warn("GPS Error:", err), { enableHighAccuracy:true });
}
</script>
</body>
</html>
