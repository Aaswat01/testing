<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Leaflet Rotate Navigation</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js"></script>

    <!-- Leaflet Rotate -->
    <script src="https://unpkg.com/leaflet-rotate/dist/leaflet-rotate.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        #map { width: 100vw; height: 100vh; }

        #compass-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border-radius: 50%;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }
        #follow-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #0078FF;
            color: white;
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 9999;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="compass-btn">ðŸ§­</div>
<div id="follow-btn">FOLLOW: ON</div>

<script>
/* ---------------- MAP CORE ---------------- */
const map = L.map("map", {
    center: [20.5937, 78.9629],
    zoom: 17,
    rotate: true,
    touchRotate: true,
    compassBearing: false, // must stay off to avoid interference
});

/* ---------------- TILE LAYER ---------------- */
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 23
}).addTo(map);

/* ---------------- STATE ---------------- */
let followMode = true;
let lastHeading = 0;
let userRotating = false;

/* ---------------- CAR MARKER ---------------- */
const userIcon = L.circleMarker([0,0], {
    radius: 8,
    color: "#ff4747",
    fillColor: "#ff6a6a",
    fillOpacity: 1
}).addTo(map);

/* ---------------- BUTTONS ---------------- */
document.getElementById("follow-btn").onclick = () => {
    followMode = !followMode;
    document.getElementById("follow-btn").innerText = `FOLLOW: ${followMode ? "ON" : "OFF"}`;
};

document.getElementById("compass-btn").onclick = () => {
    map.setBearing(0, { animate: true, duration: 300 });
};

/* ---------------- STOP FOLLOW WHEN USER TOUCHES ---------------- */
map.on("mousedown touchstart", () => {
    followMode = false;
    document.getElementById("follow-btn").innerText = "FOLLOW: OFF";
});

/* ---------------- USER ROTATION HANDLING ---------------- */
map.on("rotatestart", () => { userRotating = true; });
map.on("rotateend", () => {
    setTimeout(() => userRotating = false, 800);
});

/* ---------------- SNAP-TO-NORTH HELPER ---------------- */
function normalizeBearing(br) {
    return Math.abs(br) < 1 ? 0 : br;
}

/* ---------------- GPS LOGIC ---------------- */
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const heading = pos.coords.heading ?? lastHeading;
        lastHeading = heading;

        // update position
        userIcon.setLatLng([lat, lng]);

        // Only rotate if: follow mode ON + user NOT rotating manually
        if (followMode && !userRotating) {
            map.setBearing(normalizeBearing(heading), { animate: true, duration: 250 });
        }

        // Auto-center only if follow mode ON
        if (followMode) {
            map.panTo([lat, lng], { animate: true });
        }

    }, console.warn, { enableHighAccuracy: true });
}
</script>
</body>
</html>
